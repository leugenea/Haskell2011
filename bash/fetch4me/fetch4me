#!/bin/bash -e

#default options
config=~/.fetch4merc
referer=nyan
GETELEMFUNC=wget
QQEDIR=~/.fetch4me

source ~/.fetch4merc

#echo $QQEDIR $GETELEMFUNC

function changeReferer() {
	referer=$1
#	echo "referer changed to $referer"
}

function changeDir() {
	QQEDIR=$1
#	echo "QQEDIR changed to $QQEDIR"
}

tempurl=""
function getNormalName() {
	tempurl=$1
	tempurl=${tempurl/*\/\//""}
	tempurl=${tempurl//\//_}
}

function addTask() {
	touch $QQEDIR/.queue
	cp $QQEDIR/.queue $QQEDIR/.queuet
	touch $QQEDIR/.queuet
	echo $1 >> $QQEDIR/.queuet
	mv $QQEDIR/.queuet $QQEDIR/.queue
	getNormalName $1
	echo $1 > $QQEDIR/$tempurl.ttask
	mv $QQEDIR/$tempurl.ttask $QQEDIR/$tempurl.task
	echo $referer > $QQEDIR/$tempurl.ttaskr
        mv $QQEDIR/$tempurl.ttaskr $QQEDIR/$tempurl.taskr
}

function addTasks() {
	if [ ! -e ~/Downloads/fetched4you/$referer ]
	then
		mkdir -p ~/Downloads/fetched4you/$referer
	fi
	for i in $*
	do
		addTask $i
	done
}

while getopts ":r:w:" opt; do
	case $opt in
		r)
			if [ "$((OPTIND-1))" -eq "$#" ]
			then
				echo "It should be at least one URL (because -r used)"
			fi
			changeReferer $OPTARG
		;;

		w)
			changeDir $OPTARG
		;;

		:)
			echo "Argument required -$OPTARG"
			exit 1
		;;

		*)
			echo "Unknown arg -$OPTARG"
			exit 1
		;;
	esac
done

function start4me() {
	echo $@
	addTasks $@
	
}

state=""
function chechIfStarted() {
	if [ -e $QQEDIR/.pid ]
	then
		ps ax | grep `cat $QQEDIR/.pid` > $QQEDIR/.temp
		t=0
		while read line
		do
			t=$((t+1))
		done <$QQEDIR/.temp
		rm $QQEDIR/.temp
		if [ "$t" -eq 1 ]
		then
			state=notstarted
			echo "$$" > $QQEDIR/.pid
		else
			state=started
		fi
	else
		state=notstarted
		echo "$$" > $QQEDIR/.pid
	fi
}

shift $((OPTIND-1))
if [ ! -e $QQEDIR ]
then
	mkdir $QQEDIR
fi
chechIfStarted
if [[ "$state" -eq "notstarted" ]]
then
	start4me $@
fi
addTasks $a
echo $state
