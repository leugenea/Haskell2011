#!/bin/bash -e

#default options
config=~/.fetch4merc
referer=""
GETELEMFUNC=wget
QQEDIR=~/.fetch4me
download_dir=~/Downloads/fetched4you/
source ~/.fetch4merc
declare -a urls

function awrite() {
	local args=("$@")
	file=$(getNormalName $1)
	touch "$file.temp"
	for (( c=1; c < $#; c++ ))
	do
		echo ${args[$c]} >> "$file.temp"
	done
	mv "$file.temp" $file
}

function changeReferer() {
	referer=$1
#	echo "referer changed to $referer"
}

function changeDir() {
	QQEDIR=$1
#	echo "QQEDIR changed to $QQEDIR"
}

function getNormalName() {
	local tempurl=$1
	tempurl=${tempurl/*\/\//""}
	tempurl=${tempurl//\//_}
	echo $tempurl
}

function addTask() {
	touch $QQEDIR/.queue
	cp $QQEDIR/.queue $QQEDIR/.queuet
	echo $1 >> $QQEDIR/.queuet
	mv $QQEDIR/.queuet $QQEDIR/.queue
	if [ -z $referer ]
	then
		awrite $QQEDIR$1".task" " $1" "$1" "none"
	else
		awrite $QQEDIR$referer$1".task" " --referer $referer $1" "$1" "$referer"
	fi
}

function addTasks() {
	if [ ! -e ~/Downloads/fetched4you/$referer ]
	then
		mkdir -p ~/Downloads/fetched4you/$referer
	fi
	for u in $urls
	do
		addTask $u
	done
}

function start4me() {
	if [ ! -e $QQEDIR/.pid ]
	then
		echo -1 > $QQEDIR/.pid
	fi

	exec < $QQEDIR/.pid
	read pid
	t=`ps axu | grep "^[a-zA-Z0-9]*[ ]*$pid"` || true
	if [ -z "$t" ]
	then
		(trap '' HUP; exec ./fetch4me)&
		echo $! > "$QQEDIR/.pid"
		exit
	fi
	
	if [ $$ != "$pid" ]
	then
		if [ $# -eq 0 ]
		then
			echo "At least one arg requireda"
			exit 1
		fi
		exit
	fi

	awrite $QQEDIR/.pid $$
}

if [ ! -d $download_dir ]
then
	mkdir -p $download_dir
fi

while getopts ":r:w:" opt
do
	case $opt in
		r)
			if [ "$((OPTIND-1))" -eq "$#" ]
			then
				echo "It should be at least one URL (because -r used)"
			fi
			changeReferer $OPTARG
		;;

		w)
			changeDir $OPTARG
		;;

		:)
			echo "Argument required -$OPTARG"
			exit 1
		;;

		*)
			echo "Unknown arg -$OPTARG"
			exit 1
		;;
	esac
done

args=("$@")
c=0
OPTIND=$((OPTIND-1))
while [ $OPTIND -lt $# ]
do
	urls[$count]=${args[$OPTIND]}
	c=$((c+1))
	OPTIND=$((OPTIND+1))
done

if [ ! -e $QQEDIR ]
then
	mkdir $QQEDIR
fi

addTasks
start4me

cd $QQEDIR

if [ ! -e ".finished" ]
then
	touch .finished
fi

if [ ! -e ".queue" ]
then
	touch .queue
fi

for (( ; ; ))
do
	declare -a queue
done
