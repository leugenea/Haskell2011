#!/bin/bash -e

#default options
config=~/.fetch4merc
referer=""
GETELEMFUNC=wget
QQEDIR=~/.fetch4me
download_dir=~/Downloads/fetched4you/
source ~/.fetch4merc
declare -a urls

function awrite() {
	local args=("$@")
	file=$(getNormalName $1)
	touch "$file.temp"
	for (( c=1; c < $#; c++ ))
	do
		echo ${args[$c]} >> "$file.temp"
	done
	mv "$file.temp" $file
}

function changeReferer() {
	referer=$1
#	echo "referer changed to $referer"
}

function changeDir() {
	QQEDIR=$1
#	echo "QQEDIR changed to $QQEDIR"
}

function getNormalName() {
	local tempurl=$1
	tempurl=${tempurl/*\/\//""}
	tempurl=${tempurl//\//_}
	echo $tempurl
}

function addTask() {
	touch $QQEDIR/.queue
	cp $QQEDIR/.queue $QQEDIR/.queuet
	echo $1 >> $QQEDIR/.queuet
	mv $QQEDIR/.queuet $QQEDIR/.queue
	if [ -z $referer ]
	then
		awrite $QQEDIR$1".task" " $1" "$1" "none"
	else
		awrite $QQEDIR$referer$1".task" " --referer $referer $1" "$1" "$referer"
	fi
}

function addTasks() {
	if [ ! -e ~/Downloads/fetched4you/$referer ]
	then
		mkdir -p ~/Downloads/fetched4you/$referer
	fi
	for u in $urls
	do
		addTask $u
	done
}

function start4me() {
	(trap '' HUP; exec ./fetch4me.sh)&
	echo $! > "$QQEDIR/.pid"
}

state=""
function chechIfStarted() {
	if [ -e $QQEDIR/.pid ]
	then
		ps ax | grep `cat $QQEDIR/.pid` > $QQEDIR/.temp
		t=0
		while read line
		do
			t=$((t+1))
		done <$QQEDIR/.temp
		rm $QQEDIR/.temp
		if [ "$t" -eq 1 ]
		then
			state=notstarted
			echo "$$" > $QQEDIR/.pid
		else
			state=started
		fi
	else
		state=notstarted
		echo "$$" > $QQEDIR/.pid
	fi
}

if [ ! -d $download_dir ]
then
	mkdir -p $download_dir
fi

while getopts ":r:w:" opt
do
	case $opt in
		r)
			if [ "$((OPTIND-1))" -eq "$#" ]
			then
				echo "It should be at least one URL (because -r used)"
			fi
			changeReferer $OPTARG
		;;

		w)
			changeDir $OPTARG
		;;

		:)
			echo "Argument required -$OPTARG"
			exit 1
		;;

		*)
			echo "Unknown arg -$OPTARG"
			exit 1
		;;
	esac
done

args=("$@")
c=0
OPTIND=$((OPTIND-1))
while [ $OPTARG -lt $# ]
do
	urls[$count]=${args[$OPTIND]}
	c=$((c+1))
	OPTIND=$((OPTIND+1))
done

addTasks

if [ ! -e $QQEDIR ]
then
	mkdir $QQEDIR
fi
chechIfStarted
if [[ "$state" -eq "notstarted" ]]
then
	start4me
fi
addTasks $a
echo $state
